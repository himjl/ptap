<!doctype html>

<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<link rel="stylesheet" type="text/css" href="mkturk_style.css">

<form style="display: none;" id="MechanicalTurk_SubmissionForm" action="https://www.mturk.com/mturk/externalSubmit" method="post">
  <input type="text" name="submission_data" id="submission_data" value="">
  <input type="text" name="assignmentId" id="assignmentId" value="">
  <input type="text" name="hitId" id="hitId" value="">
</form>

<meta name="mobile-web-app-capable" content="yes"> 
<!-- full screen https://developer.chrome.com/multidevice/android/installtohomescreen -->
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> 
<!-- do not allow window rescaling.  To avoid window rescaling in portrait mode, added with=device-width from http://stackoverflow.com/questions/22771523/ipad-w-retina-safari-reported-dimensions-in-landscape-make-no-sense. Also, removes 300-350ms tap delay (https://developers.google.com/web/updates/2013/12/300ms-tap-delay-gone-away) -->

<link rel="manifest" href="mkturkmanifest.json">
<link rel="icon" href="mkturklogo48.png">
</head>

<body style="overflow-y: hidden; overflow-x:hidden; background-color:#494c51">

<div id="myProgress", style="overflow:hidden">
        <div id="AutomatorLoadBar"></div>
        <div id="StageBar"></div>
</div>

<div id="MechanicalTurk_ProgressBar", style="position: absolute; overflow:hidden; height: 3%; width:30%; margin-left:35%; margin-right:35%; border:1px solid #BDBDBD; background-color:#BDBDBD; z-index:102; visibility:hidden"; ; >
    <div id="MechanicalTurk_TrialBar"></div>
</div>

<button id="connectble" name="connectble" >Connect to Bluetooth juicer</button>
<button id="noble" name="noble">No Bluetooth juicer</button>
<button id="drive_juice_button" onclick="writepumpdurationtoBLE(500)">Send juice signal</button>
<button id="connectusb">Connect to USB juicer</button>


<div id="TrialCounter">-</div>
<div id="DebugMessageTextBox">Welcome...</div>
<div id="SessionTextBox"><b>Subject:</b> <br><b>Experiment:</b></div>
<div id="PreviewModeSplash">
  <span id='PreviewSplashText'><p style="color:red; font-size:large; font-weight:bold; text-align:center">PREVIEW MODE</p>Please use <b>Google Chrome</b> and turn your <b>sound on</b>. For the HIT to load properly, <b>cookies</b> must be enabled. Test your computer is compatible by playing with the <text style="font-weight:bold">demo below</text>.  
  </span>
</div>

<div id="MechanicalTurkInstructionsSplash">
  <span id='InstructionSplashText'> Loading instructions... </span>
  <button onclick="toggleElement(0, 'MechanicalTurkInstructionsSplash'); FLAGS.clicked_close_instructions(true)" id='CloseInstructionsButton' disabled> Loading... </button>
</div>

<div id="MechanicalTurkCursorDeviceSelectionScreen">


  <input type="image" class='DeviceButton' id='MouseImage'  style="" id="MouseImage" src="tutorial_images/mouse.png " alt="Mouse" onclick="setDeviceSelection(this, 'mouse')" />
  <input type="image"  class='DeviceButton' id='TrackPadImage' src="tutorial_images/trackpad.png " alt="Trackpad" onclick="setDeviceSelection(this, 'trackpad')" />
  <input type="image"  class='DeviceButton' id = 'TabletImage' src="tutorial_images/tablet.png " alt="Tablet" onclick="setDeviceSelection(this, 'touchscreen')" />

  <span>
  <button style="text-align:center; width:30%; height:10%; position:absolute; margin-top:5%; top: 80%; left:35%;"  onclick="toggleElement(0, 'MechanicalTurkCursorDeviceSelectionScreen'); FLAGS.clicked_device_selection(UX.MechanicalTurk_DeviceSelected)" id='CloseDeviceSelectionButton' disabled> <i>Make selection...</i> </button>
  </span>
</div>

<div id="MechanicalTurkHandSelectionScreen">

  <input type="image" class='HandButton' id='LeftHandImage'  style="" id="MouseImage" src="tutorial_images/left_hand.png " alt="Lefthanded" onclick="setHandSelection(this, 'left')" />
  <input type="image"  class='HandButton' id = 'RightHandImage' src="tutorial_images/right_hand.png " alt="Righthanded" onclick="setHandSelection(this, 'right')" />

  <span>
  <button style="text-align:center; width:30%; height:10%; position:absolute; margin-top:5%; top: 80%; left:35%;"  onclick="toggleElement(0, 'MechanicalTurkHandSelectionScreen'); FLAGS.clicked_hand_selection(UX.MechanicalTurk_Handedness)" id='CloseHandSelectionButton' disabled> <i>Make selection...</i> </button>
  </span>
</div>

<button id="doneTestingTask" name="doneTestingTask">Done with testing trials</button>

<button id = 'WorkerCashInButton' name="WorkerCashInButton">Turn in</button>


<script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
<script src="setup_upstairs_session.js" type="text/javascript"></script>
<script src="setup_MechanicalTurk_session.js" type="text/javascript"></script>

<script src="mkturk_installsettings.js"></script>
<script src="javascript_utils/seedrandom.js" type="text/javascript"></script>
<script src="mkturk_ImageBuffer.js" type="text/javascript"></script>
<script src="mkturk_bluetooth.js" type="text/javascript"></script>
<script src="mkturk_utils.js" type="text/javascript"></script>
<script src="mkturk_SoundPlayer.js" type="text/javascript"></script>
<script src="mkturk_DiskIO.js" type="text/javascript"></script>
<script src="mkturk_DataWriter.js" type="text/javascript"></script>
<script src="mkturk_TaskStreamer.js" type="text/javascript"></script>
<script src="mkturk_UX.js" type="text/javascript"></script>
<script src="mkturk_CheckPointer.js" type="text/javascript"></script>
<script src="mkturk_Playspace.js" type="text/javascript"></script>
<script src="mkturk_ActionPoller.js" type="text/javascript"></script>
<script src="mkturk_Reinforcer.js" type="text/javascript"></script>
<script src="mkturk_ScreenDisplayer.js" type="text/javascript"></script>
<script src="mkturk_amazon_utils.js" type="text/javascript"></script>
<script src="mkturk_Verifier.js"></script>

<script src="mkturk_SessionBootStrapper.js" type="text/javascript"></script>
<script src="mkturk_defaultHIT_failsafe.js" type="text/javascript"></script>

<script src="mkturk_screenfunctions.js"></script>
<script src="mkturk_usb.js"></script>


<script>


var FLAGS = {}; // todo: get rid of


(async function(){
try{

  await connectUSBButtonPromise()
  // Run the juicer for some amount of pulses
  //var juiceRewardPer1000 = 150
  //
  //var Reinforcer = new JuiceReinforcer(juiceRewardPer1000)

  var RewardDurationMsec = 100
  var numPulses = 150
  for (var i = 0; i < numPulses; i++){
    port.writepumpdurationtoUSB(Math.round(RewardDurationMsec))
    // pause 
    await sleep(RewardDurationMsec + 500)
    console.log('continuing')
  }


}// End try


//******* FAILSAFE HANDLING FOR MECHANICAL TURK *******
catch(error){
  console.log('ptap failed with the following error:')
  console.error(error)
  var errorMessage = String(error)
}
finally{
  // Should not get here unless an error took place
  // Assume failure took place in mechanical turk session (this code is irrelevant for inlab)
  // Submit the error message
  console.log('Done testing juice.')
  
}

}())



</script>
</body>
</html>