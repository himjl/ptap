<!doctype html>

<head>

    <link rel="stylesheet" type="text/css" href="style/mkturk_style.css">

    <form style="display: none;" id="MechanicalTurk_SubmissionForm" action="https://www.mturk.com/mturk/externalSubmit"
          method="post">
        <input type="text" name="submission_data" id="submission_data" value="">
        <input type="text" name="assignmentId" id="assignmentId" value="">
        <input type="text" name="hitId" id="hitId" value="">
    </form>

    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">


<body style="overflow-y: hidden; overflow-x:hidden; background-color:#494c51">

<div id="MechanicalTurk_ProgressBar" ,
     style="position: absolute; overflow:hidden; height: 3%; width:30%; margin-left:35%; margin-right:35%; border:1px solid #BDBDBD; background-color:#BDBDBD; z-index:102; visibility:hidden"
     ; ;>
    <div id="MechanicalTurk_TrialBar"></div>
</div>


<div id="TrialCounter">-</div>
<div id="DebugMessageTextBox">Welcome...</div>
<div id="RedDebugMessageTextBox"></div>

<div id="PreviewModeSplash">
  <span id='PreviewSplashText'><p
          style="color:red; font-size:large; font-weight:bold; text-align:center">PREVIEW MODE</p>Please use <b>Google Chrome</b> and turn your <b>sound on</b>. For the HIT to load properly, <b>cookies</b> must be enabled. Test your computer is compatible by playing with the <text
          style="font-weight:bold">demo below</text>.
  </span>
</div>

<div id="MechanicalTurkInstructionsSplash">
    <span id='InstructionSplashText'> Loading instructions... </span>
    <button onclick="toggleElement(0, 'MechanicalTurkInstructionsSplash'); FLAGS.clicked_close_instructions(true)"
            id='CloseInstructionsButton' disabled> Loading...
    </button>
</div>

<div id="MechanicalTurkCursorDeviceSelectionScreen">

    <input type="image" class='DeviceButton' id='MouseImage' style="" src="image_assets/mouse.png " alt="Mouse"
           onclick="setDeviceSelection(this, 'mouse')"/>
    <input type="image" class='DeviceButton' id='TrackPadImage' src="image_assets/trackpad.png " alt="Trackpad"
           onclick="setDeviceSelection(this, 'trackpad')"/>
    <input type="image" class='DeviceButton' id='TabletImage' src="image_assets/tablet.png " alt="Tablet"
           onclick="setDeviceSelection(this, 'touchscreen')"/>

    <span>
  <button style="text-align:center; width:30%; height:10%; position:absolute; margin-top:5%; top: 80%; left:35%;"
          onclick="toggleElement(0, 'MechanicalTurkCursorDeviceSelectionScreen'); FLAGS.clicked_device_selection(UX.MechanicalTurk_DeviceSelected)"
          id='CloseDeviceSelectionButton' disabled> <i>Make selection...</i> </button>
  </span>
</div>

<div id="MechanicalTurkHandSelectionScreen">

    <input type="image" class='HandButton' id='LeftHandImage' style="" src="image_assets/left_hand.png "
           alt="Lefthanded" onclick="setHandSelection(this, 'left')"/>
    <input type="image" class='HandButton' id='RightHandImage' src="image_assets/right_hand.png " alt="Righthanded"
           onclick="setHandSelection(this, 'right')"/>

    <span>
  <button style="text-align:center; width:30%; height:10%; position:absolute; margin-top:5%; top: 80%; left:35%;"
          onclick="toggleElement(0, 'MechanicalTurkHandSelectionScreen'); FLAGS.clicked_hand_selection(UX.MechanicalTurk_Handedness)"
          id='CloseHandSelectionButton' disabled> <i>Make selection...</i> </button>
  </span>
</div>

<button id='WorkerCashInButton' name="WorkerCashInButton">Bonus earned:</button>

<script src="setup_session.js" type="text/javascript"></script>
<script src="io_utils/image_loading/ImageBuffer.js" type="text/javascript"></script>
<script src="mkturk_utils.js" type="text/javascript"></script>
<script src="mkturk_SoundPlayer.js" type="text/javascript"></script>
<script src="data_recording/data_recording.js" type="text/javascript"></script>
<script src="trial_iterator.js" type="text/javascript"></script>
<script src="mkturk_UX.js" type="text/javascript"></script>
<script src="mkturk_Playspace.js" type="text/javascript"></script>
<script src="mkturk_ActionPoller.js" type="text/javascript"></script>
<script src="mkturk_ScreenDisplayer.js" type="text/javascript"></script>
<script src="mkturk_amazon_utils.js" type="text/javascript"></script>
<script src="mkturk_screenfunctions.js"></script>
<script src="io_utils/local_storage_io/load_task_def.js" type="text/javascript"></script>
<script src="tutorial/blue_orange_tutorial_generator.js" type="text/javascript"></script>

<script>

    // Todo:
    // 4. Write new data downloader / parser
    // 5. test on sandbox

    var FLAGS = {};
    var session_data = new ListDict;

    (async function () {
        try {

            // Load task def from local storage
            var task_def = await localstorage_io.load_task_def();

            // Get session information
            var landing_page_url = await localstorage_io.load_landing_page_url();
            var hitId = az.get_hitId_from_url(landing_page_url);
            var assignmentId = az.get_assignmentId_from_url(landing_page_url);
            var sandbox_mode = az.detect_sandbox_mode(landing_page_url);

            // Set up session
            var TrialIterator = new Trial_Iterator_Class(task_def);
            var freturn = await setup_session(task_def, assignmentId);
            var Playspace = freturn['Playspace'];
            var UX = freturn['UX'];

            // Attach metadata for session
            session_data.data['url'] = window.location.href;
            session_data.data['unixTimestampPageLoad'] = window.performance.timing.navigationStart;
            session_data.data['landingPageURL'] = landing_page_url;
            session_data.data['sandbox'] = sandbox_mode;

            // Turn on progressbar display; USD
            toggleElement(1, 'MechanicalTurk_ProgressBar');
            toggleElement(1, 'WorkerCashInButton');

            // Execute tutorial
            if (true){
                var TutorialIterator = new Tutorial_Generator_Class();
                while(true){
                    var tutorial_trial_data = await TutorialIterator.get_next_trial();
                    var tutorial_trial_outcome = await Playspace.run_trial(tutorial_trial_data);
                    var tutorial_state = TutorialIterator.update_state(tutorial_trial_outcome);
                    session_data.update(tutorial_trial_outcome, 'tutorial_');
                    if (tutorial_state !== 'in_progress'){
                        break
                    }
                }
            }

            if (tutorial_state === 'failure'){
                // Submit to turk; subject did not pass.
                await MechanicalTurkSubmitter.submit_data(assignmentId, hitId, sandbox_mode, session_data.data)
            }

            // Execute main trial loop
            while (TrialIterator.terminal === false) {
                var trial_data = await TrialIterator.get_next_trial();
                var trial_outcome = await Playspace.run_trial(trial_data);
                session_data.update(trial_outcome);
                UX.update_progressbar(trial_outcome);
            }
            // Attach image info to session_data
            session_data.data['bonus_USD_per_correct'] = task_def['bonus_USD_per_correct'];
            session_data.data['image_url_prefix'] = task_def['image_url_prefix'];
            session_data.data['image_url_suffixes'] = task_def['image_url_suffixes'];

            // Submit the data to Mechanical Turk
            await MechanicalTurkSubmitter.submit_data(assignmentId, hitId, sandbox_mode, {'SESSION_DATA':session_data.data})
        }
        catch (error) {
            // Error catch
            console.error(error);
            var errorMessage = String(error)
        }
        finally {
            // Error handling
            await sleep(1500);

            var dataobj = {'SESSION_DATA': session_data.data};
            document.getElementById("submission_data").value = JSON.stringify(dataobj);

            // Extract assignmentId from localstorage
            var landing_page_url = await localstorage_io.load_landing_page_url();
            var assignmentId = az.get_assignmentId_from_url(landing_page_url);
            document.getElementById("assignmentId").value = assignmentId;

            var submit_url = "https://www.mturk.com/mturk/externalSubmit";

            document.getElementById("MechanicalTurk_SubmissionForm").action = submit_url;
            console.log('Submitting failed session to mechanical turk');

            document.getElementById("MechanicalTurk_SubmissionForm").submit();
        }
    }())


</script>
</body>
</html>