<!doctype html>

<body style="background-color:#7F7F7F">

<div hidden>
    <p style="color:#7F7F7F">Trials completed:
        <text id="hud_total_trials">0</text>
    </p>
    <p style="color:#7F7F7F">Rewards:
        <text id="hud_total_rewards">0</text>
    </p>
</div>

<div id="progressbar" style="width: 35%; background-color: rgba(178,178,178,0.58); opacity:0.4; position:fixed; height:2.5%; top:2.5%; transform: translate(-50%, 0); left:50%; z-index:200">
    <div id="progressbar_state" style="width:1%; height:100%; line-height:100%; background-color:rgba(0,0,0,0.58); vertical-align: center; margin:0"></div>
</div>

<div id='user_hud'
     style="color:rgba(226,226,226,0.58); font-size:14px; text-align:right; border-width:2px; float:right; background-color:gray; border-style:solid; border-radius:10px; width:auto; opacity:0.4; visibility:hidden">
    <p style="margin-right: 5px;margin-left: 5px;">Performance:
        <text id="hud_current_performance">&nbsp&nbsp0</text>
        %
    </p>
    <p style="margin-right: 5px;margin-left: 5px;">Bonus:&nbsp
        <text id="hud_current_bonus">0.0</text>
        &cent
    </p>
</div>
</body>


<div id="instructions_html" style="visibility:hidden">
    <text style="font-weight:bold; font-size:large">Thank you for your interest and contributing to research at at
        MIT!
    </text>

    <ul>
        <li>Please use a laptop or desktop with <b>Google Chrome</b> or <b>Firefox</b> to work on this HIT as intended.
        <li>You will be completing several trials. On each trial, you'll view a rapidly flashed image of an object.
        <li><b>Your task</b> is to figure out which button to press (either "F" or "J" on your keyboard) after viewing a
            particular image.
        <li>If you made a correct choice, you will see a
            <text style="color:green; font-style:italic">green</text>
            square pop up. <b>You will also increase your bonus</b>, so give it your best shot!
        <li>If you made an incorrect choice, you will see a
            <text style="color:black; font-style:italic">black</text>
            square instead, and have to wait a bit before you can try again.
        <li>To actually start a trial, press the spacebar. The image will immediately appear, so be ready!
        <li>The session will begin with a short "warmup" task to help you learn the controls.</li>
        <li>If you encounter a bug (for example, the task freezing), please contact us and let us know. You will receive
            compensation for your time.
    </ul>
    <p>
        <text style="color:#7A7A7A; font-size:smaller; font-style:italic">If you cannot meet these requirements or if
            doing so could cause discomfort or injury, do not accept this HIT. If you are uncomfortable during the HIT,
            please feel free return it.
            You will not be penalized in any way.
        </text>
    </p>
</div>

<head>
    <title>DiCarlo Lab - Mechanical Turk</title>

    <script>
        __INJECT_JAVASCRIPT_HERE__
    </script>

    <script>
        // Hardcoded experimental parameters
        const stimulus_duration_msec = 200;
        const reward_duration_msec = 200;
        const punish_duration_msec = 800;
        const choice_duration_msec = 5000;
        const post_stimulus_delay_duration_msec = 200;
        const intertrial_delay_period_msec = 50;

        // Extract session info
        const url = window.location.href;
        var assignmentId = mechanical_turk_util_functions.get_assignmentId_from_url(url);
        var in_preview_mode = mechanical_turk_util_functions.detect_previewer(url);
        var in_sandbox = mechanical_turk_util_functions.detect_sandbox(url);
        //const developer_mode = mechanical_turk_util_functions.detect_developer_mode(url);

        // Randomly set conditions for this assignment, and store in local storage
        // Express the parameters of this session by setting the value of sequences, which is an Array of Objects, in the format given by assemble_trial_sequence.
        let sequences = __INSERT_SESSION_SEQUENCES_HERE__;

        // Setup progressbar callback function, which is to be called at the end of each trial
        let ntotal_trials = 0;
        for (let i_sequence =0; i_sequence<sequences.length; i_sequence++){
            let cur_len = sequences[i_sequence]['image_url_suffix_seq'].length;
            ntotal_trials = ntotal_trials + cur_len
        }

        function set_progressbar(width_percent){
            document.getElementById('progressbar_state').style.width = width_percent.toString().concat('%');
        }
        function progressbar_callback(){
            // Adjust the width of the progressbar
            const cur_width = parseFloat(document.getElementById('progressbar_state').style.width);
            const increment_width = 100/ntotal_trials;
            const new_width = cur_width + increment_width;
            set_progressbar(new_width);
        }

        (async function () {
            // Run instructions if they have not been clicked through
            await run_instructions(document.getElementById('instructions_html').innerHTML, in_preview_mode);

            if (in_preview_mode === false){
                // Turn on HUD
                document.getElementById('progressbar').style.visibility = 'visible';
                document.getElementById('user_hud').style.visibility = 'visible';

                // Run trials
                let session_data = await run_subtasks(sequences, checkpoint_key_prefix);

                // Submit
                await mechanical_turk_util_functions.submit_data(assignmentId, in_sandbox, session_data);
            }
        }());

    </script>
</head>


