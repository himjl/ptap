<!doctype html>

<body style="background-color:#7F7F7F">

<div hidden>
    <p style="color:#7F7F7F">Trials completed:
        <text id="hud_total_trials">0</text>
    </p>
    <p style="color:#7F7F7F">Rewards:
        <text id="hud_total_rewards">0</text>
    </p>
</div>

<div id="progressbar" style="width: 35%; background-color: rgba(178,178,178,0.58); opacity:0.4; position:fixed; height:2.5%; top:2.5%; transform: translate(-50%, 0); left:50%; z-index:200">
    <div id="progressbar_state" style="width:1%; height:100%; line-height:100%; background-color:rgba(0,0,0,0.58); vertical-align: center; margin:0"></div>
</div>

<div id='user_hud'
     style="color:rgba(226,226,226,0.58); font-size:14px; text-align:right; border-width:2px; float:right; background-color:gray; border-style:solid; border-radius:10px; width:auto; opacity:0.4; visibility:hidden">
    <p style="margin-right: 5px;margin-left: 5px;">Performance:
        <text id="hud_current_performance">&nbsp&nbsp0</text>
        %
    </p>
    <p style="margin-right: 5px;margin-left: 5px;">Bonus:&nbsp
        <text id="hud_current_bonus">0.0</text>
        &cent
    </p>
</div>
</body>


<div id="instructions_html" style="visibility:hidden">
    <text style="font-weight:bold; font-size:large">Thank you for your interest and contributing to research at at
        MIT!
    </text>

    <ul>
        <li>Please use a laptop or desktop with <b>Google Chrome</b> or <b>Firefox</b> to work on this HIT as intended.
        <li>You will be completing several trials. On each trial, you'll view a rapidly flashed image of an object.
        <li><b>Your task</b> is to figure out which button to press (either "F" or "J" on your keyboard) after viewing a
            particular image.
        <li>If you made a correct choice, you will see a
            <text style="color:green; font-style:italic">green</text>
            square pop up. <b>You will also increase your bonus</b>, so give it your best shot!
        <li>If you made an incorrect choice, you will see a
            <text style="color:black; font-style:italic">black</text>
            square instead, and have to wait a bit before you can try again.
        <li>To actually start a trial, press the spacebar. The image will immediately appear, so be ready!
        <li>The session will begin with a short "warmup" task to help you learn the controls.</li>
        <li>If you encounter a bug (for example, the task freezing), please contact us and let us know. You will receive
            compensation for your time.
    </ul>
    <p>
        <text style="color:#7A7A7A; font-size:smaller; font-style:italic">If you cannot meet these requirements or if
            doing so could cause discomfort or injury, do not accept this HIT. If you are uncomfortable during the HIT,
            please feel free return it.
            You will not be penalized in any way.
        </text>
    </p>
</div>

<head>
    <title>DiCarlo Lab - Mechanical Turk</title>

    <script>
        __INJECT_JAVASCRIPT_HERE__
    </script>

    <script>
        // Extract session info
        const url = window.location.href;
        let assignmentId = mechanical_turk_util_functions.get_assignmentId_from_url(url);
        let in_preview_mode = mechanical_turk_util_functions.detect_previewer(url);
        let in_sandbox = mechanical_turk_util_functions.detect_sandbox(url);
        const developer_mode = mechanical_turk_util_functions.detect_developer_mode(url);
        const assignment_instructions_completed_key = assignmentId.concat('_instructions_done');
        const checkpoint_key_prefix = assignmentId.concat('_checkpointed_data');

        // Randomly set conditions for this assignment, and store in local storage
        const session_parameters_key = assignmentId.concat('_session_parameters');
        let block_sequence = LocalStorageUtils.retrieve_json_object(session_parameters_key);

        if (block_sequence==null || developer_mode === true){
            // Express the parameters of this session by setting the value of sequences, which is an Array of Objects, in the format given by assemble_trial_sequence.
            //block_sequence = __INSERT_SESSION_SEQUENCES_HERE__;
            LocalStorageUtils.store_object_as_json(session_parameters_key, block_sequence);
            console.log('Stored session parameters for assignment', assignmentId);

            console.log('Developer mode: purging instructions key');
            LocalStorageUtils.remove_item(assignment_instructions_completed_key);

            // Purge existing checkpoints
            console.log('Developer mode: purging checkpoints');
            for (let i_subtask = 0; i_subtask < block_sequence.length; i_subtask++) {
                const cur_checkpoint_key = checkpoint_key_prefix.concat('_block', i_subtask.toString());
                LocalStorageUtils.remove_item(cur_checkpoint_key);
            }
        }

        block_sequence = [
            {
                'image_url_prefix':'https://milresources.s3.amazonaws.com/Images/AbstractShapes/',
                'stimulus_image_url_suffix_sequence':['bluediamond.png', 'orangediamond.png', 'bluediamond.png', 'orangediamond.png'],
                'choice0_url_suffix_sequence':['bluediamond.png', 'bluediamond.png', 'orangediamond.png', 'orangediamond.png'],
                'choice1_url_suffix_sequence':['orangediamond.png', 'bluediamond.png', 'bluediamond.png', 'bluediamond.png'],
                'rewarded_choice_sequence':[-1, -1, 1, 0],
                'stimulus_duration_msec':500,
                'reward_duration_msec':100,
                'punish_duration_msec':500,
                'choice_duration_msec':5000,
                'minimal_choice_duration_msec':3000,
                'post_stimulus_delay_duration_msec':0,
                'usd_per_reward':0,
                'block_name':'test_mil',
            },
        ]

        console.log(block_sequence);

        (async function () {
            // Run instructions if they have not been clicked through
            const completed_instructions = LocalStorageUtils.retrieve_json_object(assignment_instructions_completed_key);
            if (completed_instructions == null){
                await run_instructions(document.getElementById('instructions_html').innerHTML, in_preview_mode);
                LocalStorageUtils.store_object_as_json(assignment_instructions_completed_key, 1);
            }
            else{
                console.log('Detected subject already completed instructions; not showing')
            }

            if (in_preview_mode === false){
                // Turn on HUD
                document.getElementById('progressbar').style.visibility = 'visible';
                document.getElementById('user_hud').style.visibility = 'visible';

                // Run trials
                var session_data = await run_mts_blocks(block_sequence, checkpoint_key_prefix);

                // Submit
                await mechanical_turk_util_functions.submit_data(assignmentId, in_sandbox, session_data);
            }
        }());

    </script>
</head>


